<!DOCTYPE html>
<html>

<!--  parameters to chat:
http://slidepipertest-slidepiper.rhcloud.com/chatwindow.html
?sessionid=1&username=Ashauli1ss&role=0 
-->
<!--  requirements: bootstrap-3.0.3 jquery sockjs 
 -->
 <head>
  <title>SlidePiper Chat</title>
  <link rel="stylesheet" href="bootstrap-3.0.3/css/bootstrap.css">
  <script src="jquery/jquery-1.10.2.js"></script>
  <script src="bootstrap-3.0.3/js/bootstrap.js"></script>
  <script src="sockjs/sockjs-0.3.js"></script>  
  <style>
  	.chatcontainer {
  			width:100%;
  	    height:220px;
  		}
    .chatcontentDiv {
      width:100%;
      height:130px;
      border-color: #000000;
      border-width: thin;
      border-style: solid;
      border-radius: 3px;
      display: block;
      overflow: auto;
    }    
    	.chatcorners {    	
						background: none repeat scroll 0 0 #aabbff;
				    border-radius: 25px;
				    border: 2px solid #8AC007;
				    padding: 10px;
    		}
    
    .chatusername {
      font-weight: bold;
      color: #555599;
    }
  
  </style>
</head>
<body>
  <div class="chatcontainer chatcorners">    
    <div class="row">
      <div class="col-xs-12">
        <div class="col-xs-11"><h5><b>Chat with Shauli Daon</b></h5></div>
        <div class="col-xs-1"><button id="btnClose" class="btn btn-primary" style="width:100%;">X</button></div>
        <div class="chatcontentDiv col-xs-9" id="chatBox">
        </div>
      </div>
      <div class="col-xs-3" style="display: none;">
        <div><h3>Users</h3></div>
        <div class="chatcontentDiv" id="nicknamesBox" >
        </div>
      </div>
    </div>
    <div class="row" style="margin-top:3px;">
      <div class="col-xs-9"><input type="text" id="txtMessage" class="form-control" placeholder="Type message"/></div>
      <div class="col-xs-3"><button id="btnSend" class="btn btn-primary" style="width:100%;">Send</button></div>
    </div>
  </div>
  <script>

  // parameter from url: session id, username role
  function getURLParameter(name) {
	  return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||null
	}

  //var socket;  not used. instead:
  socket=null; //global var  
  var registered = false;
  
  function connectSocket()
  	{
		
		socket = new SockJS(socketString);        
    //When the connection is opened, login.
    	socket.onopen = function() { 
      console.log("Opened socket.");
      //register the user
      //var nickname = $("#nickname").val();
      var username = getURLParameter("username"); 
    	var sessionid = getURLParameter("sessionid");
    	var role = getURLParameter("role");
      user = { "username" : username,
    		       "sessionid" : sessionid,
    		       "role" : role
    		                  };          
      socket.send(JSON.stringify(user));
                
      //When received a message, parse it and either add/remove user or post message.
      socket.onmessage = function(a) {
        //process the message here
        console.log("parsing JSON message: " + a.data);
                    
        var message = JSON.parse(a.data);            
        //console.log("msg is: " + message.toString());
              
        console.log("message is " + JSON.stringify(message));
        
        //console.log("CHECKING PROPERTIES: ");
        //onsole.log(message.hasOwnProperty("addUser"));
        //console.log(message.hasOwnProperty("removeUser"));
        //console.log(message.hasOwnProperty("message"));
        
        //for (var key in Object.keys(message)) {
       // 	console.log("property in json: " + key);
	            //if (obj.hasOwnProperty(key)) {
	            //        /* useful code here */
	            		    //}
        			//}
                               
        // all messages I receive are already filtered by
        // server to sessionid so should be displayed.
        if (message.hasOwnProperty("addUser")) {
        	console.log("addUser detected");
          var d = document.createElement('div');
          $(d).addClass("chatusername user").text(message.addUser.username).attr("data-user", message.addUser.username.toString()).appendTo("#nicknamesBox");

          if (message.addUser.username != username) // it's not me
          				{	
	              // add online msg to chatbox
	              var d = document.createElement('div');
	              var sonline = document.createElement('span');                            
	              $(sonline).addClass("chatusername").text(message.addUser.username + " is online.").appendTo($(d));
	              $(d).appendTo("#chatBox");
	              $("#chatBox").scrollTop($("#chatBox")[0].scrollHeight);
	              		}
          
          console.log("Added user " + message.addUser.username);
        } else if (message.hasOwnProperty("removeUser")) {
        	
            if (message.removeUser.username != username) // it's not me
  						{	
           		// add offline msg to chatbox
              var d = document.createElement('div');
              var soffline = document.createElement('span');                            
              $(soffline).addClass("chatusername").text(message.removeUser.username + " is offline.").appendTo($(d));
              $(d).appendTo("#chatBox");
              $("#chatBox").scrollTop($("#chatBox")[0].scrollHeight);
  						}
              
          	console.log("removeUser detected");
            $(".user[data-user="+message.removeUser.username+"]").remove();
            console.log("Removed user " + message.removeUser.username);

        } else             	
        // only regular msgs are sent - 
        if (message.hasOwnProperty("message")) {
        	console.log("regular message detected");
        	//regular message - we have
        	// message JSON with message and user insude.
          var d = document.createElement('div');
          var suser = document.createElement('span');
          var smessage = document.createElement('span');              
          $(suser).addClass("username").text(message.message.user.username+" : ").appendTo($(d));
          $(smessage).text(message.message.messagetext).appendTo($(d));
          $(d).appendTo("#chatBox");
          $("#chatBox").scrollTop($("#chatBox")[0].scrollHeight);
        				}      
        else {alert("unknown message type" + message.toString());}
		      	}
      socket.onclose = function() { 
    	  		console.log("socket closed. trying to reconnect");
    	  		connectSocket();
    	  		};
    	  		
      socket.onerror = function() { alert("Error transmitting chat content"); };
      
      $('#txtMessage').keyup(function(e){
        if (e.keyCode == 13) {
          sendMessage();
	            	}});
	          $("#btnSend").click(function() {
	            sendMessage();
	          	});          
    	}
   
  
  function startClient() {
    console.log("opening socket");
    //on http server use document.domain instead od "localhost"
    //Start the websocket client
    if (document.domain == 'localhost')
    	{
    	// on localhost
    		socketString = document.domain + ":8080/sp/chat";
    	}
    else
    	{
    	// on openshift, no sp. and port is 8000 for ws, 8443 for wss.
				socketString = document.domain + ":8000/chat";
    	}
    socketString = "http://" + socketString;    
    console.log("connecting to socket " + socketString);
    
    // timeout because I see msgs in reverse order.
    // first I see console log and then GET.
    // maybe this will help it appear in correct order.
    // AND - solve HTTP FORBIDDEN issue (only on openshift)
    // SOLVED: I just put allowedRegion=*.
    // Also I don't chat to appear immediately.
    setTimeout(connectSocket,  5000);    
  } // of startClient
  
  function sendMessage() {
    if ($("#txtMessage").val()) {
      socket.send($("#txtMessage").val());
      $("#txtMessage").val("");
    	}
    }
  
  
  //startup
  $(document).ready(function() {
       startClient();    
    });
    
  //}); I think it's a mistake.
  
  </script>  
</body>

